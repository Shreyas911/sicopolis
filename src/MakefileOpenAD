all: numCore.pre.xb.x2w.w2f.post.f90

ifndef F90C
F90C=gfortran
endif
ifndef CC
CC=gcc
endif

ifndef HEADER
HEADER=ref_output_10y_OAD
endif

#ifndef LISDIR
#LISDIR=/net/confucius/raid13/home/llogan/opt/LIS/installation
#endif

ifdef LISDIR
LIBLIS=${LISDIR}/lib/liblis.so
LIBLISFLAG=-L${LISDIR}/lib -llis
LIS_TEMPATE=./oad_template_sico_lis_solver.f90
LISFLAG=-DBUILD_LIS -I${LISDIR}/include/
endif

F90FLAGS= -O3 -g -DRUN_SPECS_HEADER=\"sico_specs.h\" -mcmodel=medium -fno-range-check -ffpe-trap=invalid,zero 
CFLAGS= -O3 -g

#F90FLAGS= -O0 -g -DRUN_SPECS_HEADER=\"sico_specs.h\" -mcmodel=medium -fno-range-check -ffpe-trap=invalid,zero
#CFLAGS= -O0 -g

SRC_SICO_PASSIVE=\
subroutines/grl/sico_init_m.F90\
subroutines/ant/sico_init_m.F90\
subroutines/general/error_m.F90\
subroutines/general/init_temp_water_age_m.F90\
subroutines/openad/openad_m.F90

SRC_SICO_SOLVERS=\
subroutines/general/sico_maths_m_stub.F90

SRC_SICO=\
subroutines/general/sico_types_m.F90\
subroutines/general/sico_variables_m.F90\
subroutines/grl/sico_vars_m.F90\
subroutines/general/ice_material_properties_m.F90\
subroutines/general/stereo_proj_m.F90\
subroutines/general/metric_m.F90\
subroutines/general/nc_check_m.F90\
subroutines/general/read_m.F90\
subroutines/general/mask_update_sea_level_m.F90\
subroutines/general/pdd_m.F90\
subroutines/general/calving_underwater_ice_m.F90\
subroutines/grl/discharge_workers_m.F90\
subroutines/general/calc_vxy_m.F90\
subroutines/general/calc_vz_m.F90\
subroutines/general/calc_dxyz_m.F90\
subroutines/general/calc_gia_m.F90\
subroutines/general/topograd_m.F90\
subroutines/general/calc_thk_m.F90\
subroutines/general/enth_temp_omega_m.F90\
subroutines/general/calc_temp_m.F90\
subroutines/general/calc_temp_enth_m.F90\
subroutines/general/calc_enhance_m.F90\
subroutines/general/calc_temp_melt_bas_m.F90\
subroutines/general/calc_bas_melt_m.F90\
subroutines/general/calc_thk_water_bas_m.F90\
subroutines/grl/boundary_m.F90\
subroutines/ant/boundary_m.F90\
subroutines/general/sico_main_loop_m.F90\
subroutines/openad/sico_main_loop_wrapper_m.F90\
subroutines/openad/sico_main_loop_iter_m.F90

SRC_SICO_COST=\
subroutines/openad/ctrl_m.F90

SRC=\
sicopolis.F90

CPPCMD = cat $< |  cpp -DRUN_SPECS_HEADER=\"sico_specs.h\" -DALLOW_OPENAD_DIFFERENTIATE=1 -DALLOW_OPENAD=1 -I../ -I./ -traditional-cpp -P 

numCore.f90: numCore.F90
	$(CPPCMD) > numcore_temp.F90
	cat numcore_temp.F90|\
                              sed 's/use */use oad_/' |\
                              sed 's/module */\module oad_/' |\
                              sed 's/ctrl_init/\oad_ctrl_init/' |\
                              sed 's/cost_independent_init/\oad_cost_independent_init/' |\
                              sed 's/cost_dependent_init/\oad_cost_dependent_init/' |\
                              sed 's/cost_final/\oad_final/' |\
                              sed 's/module oad_procedure/\module procedure/' |\
                              sed 's/use oad_sico_maths_m/ use oad_sico_maths_m_stub/'\
                            > $@

oad_template_sico_lis_solver.f90: subroutines/openad/oad_template_sico_lis_solver.f90
	cp $^ $@

oad_template_sor_sprs.f90: subroutines/openad/oad_template_sor_sprs.f90
	cp $^ $@

oad_template_tri_sle.f90: subroutines/openad/oad_template_tri_sle.f90
	cp $^ $@

oad_template_my_erfc.f90: subroutines/openad/oad_template_my_erfc.f90
	cp $^ $@

numCore.F90: sicopolis.F90 sico_specs.h $(SRC) $(SRC_SICO) $(SRC_SICO_COST) $(SRC_SICO_SOLVERS)
	python preprocessor.py sicopolis.F90

RUN=$(HEADER)
INDIR=../sico_in
RESDIR=../sico_out/$(HEADER)
sico_specs.h: ../runs/headers/sico_specs_$(HEADER).h
	cp $^ sico_specs_temp.h
	# Reading the header and changing the values
	sed 's%INPATH .*%INPATH '\'''${INDIR}\''%' sico_specs_temp.h | sed 's%OUTPATH .*%OUTPATH '\'''${RESDIR}\''%' > $@

PREPROCESS_FLAGS=--mode=r
#POSTPROCESS_FLAGS=--mode=r --infoUnitFile w2f__types.f90 --inputFormat=free
POSTPROCESS_FLAGS=--mode=r --infoUnitFile w2f__types.f90

# preprocess F
head_sf.pre.f: numCore.f90
	${OPENADROOT}/OpenADFortTk/tools/SourceProcessing/preProcess.py $(PREPROCESS_FLAGS) --timing -o $@ numCore.f90

# F -> WHIRL
head_sf.pre.B: head_sf.pre.f 
	${OPEN64ROOT}/crayf90/sgi/mfef90 -z -N132 $<
#	${OPEN64ROOT}/crayf90/sgi/mfef90 -z -F -N132 $<

# WHIRL -> XAIF
head_sf.pre.xaif : head_sf.pre.B 
	${OPENADFORTTK}/bin/whirl2xaif -N -n -o $@ $<

# XAIF -> XAIF'
head_sf.pre.xb.xaif : head_sf.pre.xaif
	${XAIFBOOSTER_BASE}/algorithms/BasicBlockPreaccumulationReverse/driver/oadDriver -f -v -V -i $< \
           -c ${XAIFSCHEMAROOT}/schema/examples/inlinable_intrinsics.xaif \
           -s ${XAIFSCHEMAROOT}/schema/ \
           -o $@ 

# XAIF' -> WHIRL'
head_sf.pre.xb.x2w.B : head_sf.pre.xb.xaif 
	 ${OPENADFORTTK}/bin/xaif2whirl -t OpenADTy_active head_sf.pre.B $<

# WHIRL' -> F'
head_sf.pre.xb.x2w.w2f.f: head_sf.pre.xb.x2w.B 
	${OPEN64ROOT}/whirl2f/whirl2f -openad -openadType OpenADTy_active  $<

# postprocess F'
numCore.pre.xb.x2w.w2f.post.f90 :  head_sf.pre.xb.x2w.w2f.f \
                                   w2f__types.f90 \
                                   OAD_tape.f90 \
                                   OAD_active.f90 \
                                   OAD_cp.f90 \
                                   ad_template.f \
                                   ad_revolve_template.F\
                                   oad_template_sor_sprs.f90 \
                                   ${LIS_TEMPATE} \
                                   oad_template_tri_sle.f90\
                                   oad_template_my_erfc.f90
	#cp subroutines/openad/ad_inline_custom.f ./ad_inline.f
	cp ./subroutines/openad/ad_inline_dynamic.F ./ad_inline.f
	${OPENADROOT}/OpenADFortTk/tools/SourceProcessing/postProcess.py \
          $(POSTPROCESS_FLAGS) --timing --abstractType OpenADTy_active \
          $< --filenameSuffix=".pre.xb.x2w.w2f.post" \
             --pathSuffix='./' \
          $(postProcessVerbFlag) \
          ${EXAMPLE_SPECIFIC_POSTPROCESS_OPTIONS} \
          -o numCore.pre.xb.x2w.w2f.post.f90
RTSUPP=w2f__types OAD_active OAD_cp OAD_tape OAD_rev
driver:   $(addsuffix .o, $(RTSUPP) iaddr) sico_specs.h \
                                           OAD_tape.o \
                                           OAD_active.o \
                                           w2f__types.o \
                                           OAD_cp.o \
                                           OAD_revolve_cp.o\
                                           revolve.o\
                                           subroutines/general/sico_types_m.o \
                                           subroutines/general/sico_maths_m.o \
                                           ${LIBLIS} \
                                           subroutines/general/sico_maths_m_grad.o \
                                           numCore.pre.xb.x2w.w2f.post.o \
                                           sicopolis.o
	${F90C} ${F90FLAGS} -o $@ \
                         revolve.o \
                         subroutines/general/sico_maths_m.o \
                         subroutines/general/sico_maths_m_grad.o \
                         numCore.pre.xb.x2w.w2f.post.o \
                         sicopolis.o \
                         ${LIBLISFLAG}\
                           $(addsuffix .o, $(RTSUPP) iaddr) -lm

drivergrdchk: sico_specs.h $(SRC_SICO_PASSIVE) $(SRC_SICO_SOLVERS) $(SRC_SICO) $(SRC_SICO_COST) $(SRC)
	${F90C} -I./ ${F90FLAGS} ${LISFLAG} -o sicopolis.o -c $(SRC)
	${F90C} ${F90FLAGS} -o $@ sicopolis.o ${LIBLISFLAG} -lm

sicopolis.o: $(SRC_SICO_PASSIVE) $(SRC_SICO_SOLVERS) $(SRC_SICO) $(SRC_SICO_COST) $(SRC)
	${F90C} -DALLOW_OPENAD ${LISFLAG} -I./ ${F90FLAGS} -o $@ -c $(SRC)

subroutines/general/sico_maths_m.o : subroutines/general/sico_maths_m.F90
	${F90C} -DALLOW_OPENAD ${LISFLAG} -I./ ${F90FLAGS} -o $@ -c $<

subroutines/general/sico_maths_m_grad.o : subroutines/general/sico_maths_m_grad.F90
	${F90C} -DALLOW_OPENAD ${LISFLAG} -I./ ${F90FLAGS} -o $@ -c $<
subroutines/openad/openad_m.o: subroutines/openad/openad_m.F90
	${F90C} -DALLOW_OPENAD ${LISFLAG} -I./ ${F90FLAGS} -o $@ -c $<

w2f__types.f90: ${OPENADROOT}/runTimeSupport/all/w2f__types.f90
	cp   ${OPENADROOT}/runTimeSupport/all/w2f__types.f90      ./

iaddr.c:     ${OPENADROOT}/runTimeSupport/all/iaddr.c
	cp   ${OPENADROOT}/runTimeSupport/all/iaddr.c             ./

OAD_cp.f90:  ${OPENADROOT}/runTimeSupport/cpToFile/OAD_cp.f90
	cp   ${OPENADROOT}/runTimeSupport/cpToFile/OAD_cp.f90       ./

OAD_revolve_cp.f90: ${OPENADROOT}/runTimeSupport/simple/OAD_cp.f90
	cat ${OPENADROOT}/runTimeSupport/simple/OAD_cp.f90 |sed 's/OAD_cp/OAD_revolve_cp/' > ./OAD_revolve_cp.f90

revolve.f90: subroutines/openad/revolve.f90
	cp $< $@

OAD_rev.f90: ${OPENADROOT}/runTimeSupport/simple/OAD_rev.f90
	cp   ${OPENADROOT}/runTimeSupport/simple/OAD_rev.f90      ./  
#OAD_tape.f90: ${OPENADROOT}/runTimeSupport/simple/OAD_tape.f90
#	cp   ${OPENADROOT}/runTimeSupport/simple/OAD_tape.f90     ./ 

OAD_tape.f90: ./subroutines/openad/OAD_tape_dynamic.F90
	cp    ./subroutines/openad/OAD_tape_dynamic.F90           ./OAD_tape.f90

OAD_trace.f90: ${OPENADROOT}/runTimeSupport/simple/OAD_trace.f90
	cp     ${OPENADROOT}/runTimeSupport/simple/OAD_trace.f90  ./

OAD_active.f90:${OPENADROOT}/runTimeSupport/scalar/OAD_active.f90
	cp     ${OPENADROOT}/runTimeSupport/scalar/OAD_active.f90 ./

ad_revolve_template.F: ./subroutines/openad/ad_revolve_template.F
	cp $< $@

ad_template.f:
	cp     ${OPENADROOT}/runTimeSupport/simple/ad_template.split.f ./ad_template.f 

%.o : %.F90
	${F90C} -I./ ${F90FLAGS} -o $@ -c $<

%.o : %.f90
	${F90C} ${F90FLAGS} -o $@ -c $< 

%.o : %.f
	${F90C} ${F90FLAGS} -o $@ -c $< 

%.o : %.c
	${CC} ${CFLAGS} -o $@ -c $< 

clean: 
	rm -f subroutines/openad/*.o \
              subroutines/general/*.o\
              numCore.pre.xb.x2w.w2f.post.o\
              sicopolis.o\
	rm -f numCore.*\
              numcore_temp.F90\
              *.o\
              *.mod*\
              driver\
              *~\
              oad_template_*.*\
              sico_specs.h\
              sico_specs_temp.h
	rm -f ad_template*\
              ad_inline.f\
              OAD_*\
              w2f__*\
              iaddr*\
              stream_vel_variables_passive.f90\
              head_sf*
cleanobj: 
	rm -f subroutines/openad/*.o \
              subroutines/general/*.o\
              *.o

.PHONY: clean
